{% block content %}
<div class="content" style="height: calc(100% - 20px); overflow-y: clip;">
    <div class="columns">
        <div class="column is-3 tile is-parent is-vertical">
            <div class="tile is-child">
                <div class="field">
                    <label class="label">Kokouspäivä</label>
                    <div class="control">
                        <select class="input is-primary" id="rooms-search-day">
                            <option value="">Valitse päivä</option>
                            {% for day in open_days %}
                            <option value="{{ day.id }}">{{ day }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Henkilömäärä</label>
                    <div class="control">
                        <input class="input" type="number" min="2" max="800" id="rooms-search-seats">
                    </div>
                </div>

                <button type="button" class="button is-primary" onclick="rooms_search();">Hae</button>
            </div>
            {% if user.is_staff %}
            <div class="tile is-child">
                <button type="button" class="button is-primary" onclick="rooms_modal_open();">Lisää tila</button>
            </div>
            {% endif %}
        </div>

        <div class="column">
            <div class="tile is-parent" id="rooms-list">

            </div>
        </div>
    </div>
</div>

<div id="room-template" class="tile is-child is-4 p-2" style="display: none;">
    <div class="notification is-primary">
        <a href="#" onclick="room_modal_open(this);"><h3 class="title"></h3></a>
        <div class="room-info">
            <p>Kapasiteetti <span class="room-capacity"></span><br/>
            <span class="room-description"></span></p>
        </div>
    </div>
</div>

<div id="room-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="width: 80vw; height: calc(100vh - 40px);">
        <header class="modal-card-head">
            <p class="modal-card-title">Kokoustilan tiedot</p>
            <button class="delete" aria-label="close" onclick="room_modal_close();"></button>
        </header>
        <section class="modal-card-body">
            <div class="columns" style="height: 100%;">
                <div class="column is-third">
                    <div class="field">
                        <span class="tag is-info">Kokoustila</span>
                        <p class="title is-4 m-2" id="room-modal-name"></p>
                    </div>
                    <div class="field">
                        <span class="tag is-info">Kapasiteetti</span>
                        <h3 class="title is-4 m-2" id="room-modal-capacity"></h3>
                    </div>
                    <div class="field">
                        <span class="tag is-info">Kuvaus</span>
                        <p id="room-modal-description" class="m-2"></p>
                    </div>
                </div>
                <div class="column is-two-thirds">
                    <h3 class="title">Aukioloajat</h3>
                    <table class="table" id="room-times-table">
                    </table>
                </div>
            </div>
        </section>
    </div>
</div>

<div id="rooms-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Tila</p>
            <button class="delete" aria-label="close" onclick="rooms_modal_close();"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Nimi</label>
                <div class="control">
                    <input class="input" type="text" id="rooms-modal-name">
                </div>
            </div>
            <div class="field">
                <label class="label">Kapasiteetti</label>
                <div class="control">
                    <input class="input" type="number" min="2" max="800" id="rooms-modal-capacity">
                </div>
            </div>
            <div class="field">
                <label class="label">Kuvaus</label>
                <div class="control">
                    <textarea class="textarea" id="rooms-modal-description"></textarea>
                </div>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-primary" onclick="rooms_modal_save();">Tallenna</button>
            <button class="button" onclick="rooms_modal_close();">Peruuta</button>
        </footer>
    </div>

    {% csrf_token %}
<script>

const csrf_token = document.querySelector('[name="csrfmiddlewaretoken"]').value;

function rooms_search() {
    var day = $("#rooms-search-day").val();
    var seats = $("#rooms-search-seats").val();

    $.get("/api/rooms/?day=" + day + "&seats=" + seats, function(data) {
        $("#rooms-list").html("");
        for(var i = 0; i < data.length; i++) {
            var room = data[i];
            var room_html = $("#room-template").clone();
            room_html.find(".notification").attr("id", "room-" + room.id);
            room_html.removeAttr("style");
            room_html.find(".title").text(room.name);
            room_html.find(".room-capacity").text(room.capacity);
            room_html.find(".room-description").text(room.description);
            $("#rooms-list").append(room_html);
        }
    });
}

rooms_search();

$("#rooms-search-day").change(function() {
    rooms_search();
});

$("#rooms-search-seats").keyup(function() {
    rooms_search();
});

function room_modal_open(elem) {
    var room_id = $(elem).closest(".notification").attr("id").substring(5);
    $.get("/api/room/" + room_id, function(data) {
        $("#room-modal-name").text(data.name);
        $("#room-modal-capacity").text(data.capacity);
        $("#room-modal-description").text(data.description);
        $("#room-times-table").html("");
        for(var i = 0; i < data.open_times.length; i++) {
            var open_time = data.open_times[i];
            var time_html = "<tr><th>" + open_time.day.name + "</th><th>" + open_time.day.date + "</th></tr>";
            for(var j = 0; j < open_time.times.length; j++) {
                var time = open_time.times[j];
                console.log(time);
                time_html += "<tr><td>" + time.start_time + "</td><td>" + time.end_time + "</td></tr>";
            }
            $("#room-times-table").append(time_html);
        }
        $("#room-modal").addClass("is-active");
    });
}

function room_modal_close() {
    $("#room-modal").removeClass("is-active");
}

function rooms_modal_open() {
    $("#rooms-modal").addClass("is-active");
}

function rooms_modal_close() {
    $("#rooms-modal").removeClass("is-active");
    $("#rooms-modal input").val("");
}

function rooms_modal_save() {
    var name = $("#rooms-modal-name").val();
    var capacity = $("#rooms-modal-capacity").val();
    var description = $("#rooms-modal-description").val();

    $.ajax({
        url: "/api/room/",
        type: "POST",
        data: {
            name: name,
            capacity: capacity,
            description: description
        },
        headers: {
            "X-CSRFToken": csrf_token
        },
        success: function(data) {
            rooms_modal_close();
            rooms_search();
        }
    });
}

</script>
{% endblock %}