{% extends "base.html" %}
{% load static %}
{% block content %}
<script>

</script>
<style>

ul, li {
    list-style: none;
    margin: 0;
    padding: 0;
}

#rooms-schedule {
    height: 100%;
    width: 100%;
    overflow-y: auto;
    position: absolute;
}

#rooms-schedule-timeline {
    padding-top: 50px;
}

.rooms-schedule-timeline {
    position: relative;
    height: 50px;
}

.rooms-schedule-timeline:after {
    content: "";
    width: calc(100% - 60px);
    left: 60px;
    position: absolute;
    bottom: 0;
    height: 1px;
    background-color: #dbdbdb;
}

</style>
<div class="columns" style="height: 100%; margin: 0px;">
    <div class="column p-2 is-1 has-text-centered">
        <div class="is-boxed">
            <img src="{% static 'img/logo.png' %}" style="max-width: 60px;">
        </div>
    </div>
    <div class="column" style="width: auto;">
        <div class="box content p-4" id="pages-content" style="height: calc(100% - 20px);">
            <div class="tile">
                <div class="tile is-3">
                    <div class="field" style="width: 100%;">
                        <label>P채iv채</label>
                        <div class="control">
                            <select class="input" id="rooms-status-day">
                                <option value="">Valitse p채iv채</option>
                                {% for day in open_days %}
                                <option value="{{ day.id }}">{{ day }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="tile is-9">

                </div>
            </div>

            <div class="tile" style="overflow-y: auto; height: calc(100% - 60px); position: relative;">
                <div id="rooms-schedule">
                    <div id="rooms-schedule-timeline"></div>
                    <div id="rooms-schedule-bookings"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

var rooms = null;
function rooms_search() {
    var day = $("#rooms-status-day").val();

    $.get("/api/rooms/?day=" + day, function(data) {
        rooms = data;
        console.log(rooms);
        rooms_refresh();
    });
}

$("#rooms-status-day").change(function() {
    rooms_search();
});

function rooms_refresh() {
    var start_time = null;
    var end_time = null;
    for(var i = 0; i < rooms.length; i++) {
        var room = rooms[i];
        room.open_times.forEach(function(open_time) {
            if(open_time.day.id == $("#rooms-status-day").val()) {
                for(var j = 0; j < open_time.times.length; j++) {
                    var start = open_time.times[j].start_time.split(":");
                    start = parseInt(start[0]) * 60 + parseInt(start[1]);
                    if(start_time == null || start < start_time) {
                        start_time = start;
                    }
                    var end = open_time.times[j].end_time.split(":");
                    end = parseInt(end[0]) * 60 + parseInt(end[1]);
                    if(end_time == null || end > end_time) {
                        end_time = end;
                    }
                }
            }
        });
    }

    var timeline = "<ul>";
    for(var i = start_time; i < end_time; i) {
        var hours = Math.floor(i / 60);
        timeline += "<li class='rooms-schedule-timeline'><span>" + hours + ":00<span></li>";
        timeline += "<li class='rooms-schedule-timeline'></li>";
        i += 60;
    }
    timeline += "</ul>";
    $("#rooms-schedule-timeline").html(timeline);

    var bookings = "<ul>";
    for(var i = 0; i < rooms.length; i++) {
        var room = rooms[i];
        bookings += "<li class='rooms-schedule-bookings'>";
        bookings += "<div class='tile is-3'><div class='tile is-parent'><div class='tile is-child'><div class='box'><div class='content'><h3 class='title'>" + room.name + "</h3></div></div></div></div></div>";
        bookings += "<div class='tile is-9'><div class='tile is-parent'><div class='tile is-child'><div class='box'><div class='content'><ul>";
        room.open_times.forEach(function(open_time) {
            if(open_time.day.id == $("#rooms-status-day").val()) {
                open_time.times.forEach(function(time) {
                    var start = time.start_time.split(":");
                    start = parseInt(start[0]) * 60 + parseInt(start[1]);
                    var end = time.end_time.split(":");
                    end = parseInt(end[0]) * 60 + parseInt(end[1]);
                    var booking = "<li class='rooms-schedule-bookings-time' style='left: " + (start / (end_time - start_time) * 100) + "%; width: " + ((end - start) / (end_time - start_time) * 100) + "%;'>";
                    booking += "<div class='box'><div class='content'><h3 class='title'>" + time.booking.name + "</h3>";
                    booking += "<p>" + time.booking.description + "</p>";
                    booking += "</div></div></li>";
                    bookings += booking;
                });
            }
        });
        bookings += "</ul></div></div></div></div></li>";
    }
}

</script>

{% endblock %}