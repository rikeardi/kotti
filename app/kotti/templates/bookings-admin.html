{% block content %}
<h4 class="title">Hallinnoitavat varaukset</h4>
<div class="tile is-parent" id="bookings-admin-list">
    <table class="table" id="bookings-admin-table">
    </table>
</div>
<script>

function bookings_admin_refresh() {
    if($('#bookings-old').is(':checked')) {
        var old = '&old=1';
    } else {
        var old = '';
    }

    if($('#bookings-current').is(':checked')) {
        var current = '&current=1';
    } else {
        var current = '';
    }

    if($('#bookings-future').is(':checked')) {
        var future = '&future=1';
    } else {
        var future = '';
    }

    $.get('/api/rooms/?admin=' + user_id + old + current + future, function(data) {
        $('#bookings-admin-table').html('');
        $.each(data, function(i, item) {
            var room_html = '<tr><th class="is-primary">Huone</th><td class="is-primary" colspan=6>' + item.name + '</td></tr>';
            for(var i=0; i < item.bookings.length; i++) {
                var booking = item.bookings[i];
                if((old != '' && check_date(booking.date.date) == 1)||(current != '' && check_date(booking.date.date) == 2)||(future != '' && check_date(booking.date.date) == 3)||(old == '' && current == '' && future == '')) {
                    room_html += '<tr>';
                    room_html += '<td>' + booking.user.first_name + ' ' + booking.user.last_name + '</td>';
                    room_html += '<td>' + booking.date.name + ' ' + parse_date(booking.date.date) + '</td>';
                    room_html += '<td>' + parse_time(booking.start_time) + '</td>';
                    room_html += '<td>' + parse_time(booking.end_time) + '</td>';
                    if(booking.approved == 0) {
                        room_html += '<td><div class="dropdown"><div class="dropdown-trigger">' +
                        '<button class="button" aria-haspopup="true" aria-controls="bookings-approval-' + booking.id + '">' +
                        '<span>' + approval(booking.approved) + '</span>' +
                        '<span class="icon is-small"><i class="fas fa-angle-down" aria-hidden="true"></i></span>' +
                        '</button></div>' +
                        '<div class="dropdown-menu" id="bookings-approval-' + booking.id + '" role="menu">' +
                        '<div class="dropdown-content">' +
                        '<a class="dropdown-item" href="#" onclick="booking_approve(' + booking.id + ')">Hyväksy</a>' +
                        '<a class="dropdown-item" href="#" onclick="booking_reject(' + booking.id + ')">Hylkää</a>' +
                        '</div></div></div></td>';
                    } else {
                        room_html += '<td>' + approval(booking.approved) + '</td>';
                    }
                    room_html += '<td>' + booking.persons + ' hlöä</td>';
                    room_html += '</tr>';
                }
            }
            $('#bookings-admin-table').append(room_html);
        });
    });
}

bookings_admin_refresh();

$("#bookings-old").change(function() {
    bookings_admin_refresh();
});

$("#bookings-current").change(function() {
    bookings_admin_refresh();
});

$("#bookings-future").change(function() {
    bookings_admin_refresh();
});

function booking_approve(id) {
    $.ajax({
        url: '/api/bookings/' + id + '/',
        type: 'PATCH',
        data: {
            approved: 1
        },
        success: function(data) {
            bookings_admin_refresh();
        }
    });
}

function booking_reject(id) {
    $.ajax({
        url: '/api/bookings/' + id + '/',
        type: 'PATCH',
        data: {
            approved: 2
        },
        success: function(data) {
            bookings_admin_refresh();
        }
    });
}

</script>
{% endblock %}